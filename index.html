<!DOCTYPE html>
<html>

<head>
    <base target="_top">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src='https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js'></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.min.js"></script>
    <!-- Supabase JS Library -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.45.0"></script>
    <script>
        // PDF.js worker setup
        const pdfjsLib = window.pdfjsLib || window['pdfjs-dist/build/pdf'];
        if (pdfjsLib) {
            pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.worker.min.js';
        }

        // ============================================
        // KONFIGURASI SUPABASE
        // ============================================
        const SUPABASE_URL = 'https://pzkbngbbhbcqdikwlqnl.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InB6a2JuZ2JiaGJjcWRpa3dscW5sIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE0MTcwODksImV4cCI6MjA4Njk5MzA4OX0.bqUxAUQZ4KkS-cAWtgy7mA51Ksi6qZFDsbtRvRHjs2A';

        // Initialize Supabase Client
        let supabase = null;

        function initSupabase() {
            try {
                if (window.supabase && typeof window.supabase.createClient === 'function') {
                    supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
                    console.log('‚úÖ Supabase initialized successfully');
                    console.log('URL:', SUPABASE_URL);
                    return true;
                } else {
                    console.error('‚ùå Supabase library not loaded properly');
                    return false;
                }
            } catch (e) {
                console.error('‚ùå Supabase init error:', e);
                return false;
            }
        }

        // Initialize on load
        document.addEventListener('DOMContentLoaded', function () {
            initSupabase();
        });
    </script>
    <style>
        :root {
            --primary: #4f46e5;
            --primary-dark: #4338ca;
            --secondary: #64748b;
            --background: #f1f5f9;
            --surface: #ffffff;
            --text-main: #1e293b;
            --text-muted: #64748b;
            --danger: #ef4444;
            --success: #22c55e;
            --sidebar-width: 260px;
        }

        .hidden {
            display: none !important;
        }

        .page-view {
            display: none;
            width: 100%;
            height: 100%;
            animation: fadeIn 0.3s ease-in-out;
        }

        .page-view.active {
            display: block;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(5px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Inter', sans-serif;
        }

        body {
            background-color: var(--background);
            color: var(--text-main);
            height: 100vh;
            overflow: hidden;
        }

        .btn-primary {
            background-color: var(--primary);
            color: white;
            border: none;
            padding: 0.75rem 1rem;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: 0.2s;
        }

        .btn-primary:hover {
            background-color: var(--primary-dark);
        }

        .btn-action {
            padding: 4px 8px;
            border-radius: 4px;
            border: none;
            cursor: pointer;
            color: white;
            margin-right: 5px;
            font-size: 0.8rem;
        }

        .form-input {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            margin-top: 5px;
        }

        .form-group {
            margin-bottom: 1rem;
        }

        /* Layout */
        #main-dashboard {
            display: flex;
            height: 100vh;
            width: 100%;
            overflow: hidden;
        }

        .sidebar {
            width: var(--sidebar-width);
            background: var(--surface);
            border-right: 1px solid #e2e8f0;
            display: flex;
            flex-direction: column;
            transition: all 0.3s ease;
            z-index: 50;
            overflow-x: hidden;
        }

        .sidebar.collapsed {
            width: 0;
            border-right: none;
        }

        .main-content {
            flex: 1;
            overflow: auto;
            display: flex;
            flex-direction: column;
            position: relative;
        }

        .top-header {
            height: 60px;
            background: white;
            border-bottom: 1px solid #e2e8f0;
            display: flex;
            align-items: center;
            padding: 0 20px;
            gap: 15px;
            position: sticky;
            top: 0;
            z-index: 40;
        }

        .page-container {
            padding: 20px;
            flex: 1;
        }

        #menu-toggle {
            background: none;
            border: none;
            cursor: pointer;
            padding: 5px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 4px;
        }

        #menu-toggle:hover {
            background: #f1f5f9;
        }

        /* Sidebar Responsive */
        @media (max-width: 768px) {
            .sidebar {
                position: fixed;
                height: 100vh;
                transform: translateX(-100%);
                width: var(--sidebar-width) !important;
                z-index: 1000;
            }

            .sidebar.mobile-open {
                transform: translateX(0);
            }
        }

        /* Overlay Loading */
        #loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(5px);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            transition: opacity 0.3s ease;
        }

        .spinner {
            width: 50px;
            height: 50px;
            border: 5px solid #f3f3f3;
            border-top: 5px solid var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 15px;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        .loading-text {
            font-weight: 600;
            color: var(--primary);
        }

        /* Toast Notification */
        #toast-container {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 10000;
            pointer-events: none;
        }

        .toast {
            background: rgba(0, 0, 0, 0.85);
            color: white;
            padding: 16px 28px;
            border-radius: 12px;
            font-weight: 500;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
            display: flex;
            align-items: center;
            gap: 12px;
            opacity: 0;
            transform: scale(0.8);
            transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            backdrop-filter: blur(4px);
            margin-bottom: 10px;
        }

        .toast.show {
            opacity: 1;
            transform: scale(1);
        }

        .toast-success {
            border-left: 4px solid #10b981;
        }

        .toast-error {
            border-left: 4px solid #ef4444;
        }

        .toast-info {
            border-left: 4px solid #3b82f6;
        }

        /* Login */
        #login-page {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 100;
            background: white;
            display: flex;
            flex-direction: row;
        }

        .login-image-section {
            flex: 1;
            background-color: #f1f5f9;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            position: relative;
        }

        .login-image-section img {
            width: 100%;
            height: 100%;
            object-fit: contain;
            padding: 20px;
        }

        .login-form-section {
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
            padding: 3rem;
            background: linear-gradient(135deg, #fef9c3 0%, #e9d5ff 50%, #ffedd5 100%);
            background-image: url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%239C92AC' fill-opacity='0.05'%3E%3Cpath d='M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E"), linear-gradient(135deg, #fef9c3 0%, #e9d5ff 50%, #ffedd5 100%);
            max-width: 600px;
            margin: 0 auto;
        }

        .marquee-container {
            position: absolute;
            top: 20px;
            left: 0;
            width: 100%;
            z-index: 10;
            background: rgba(255, 255, 255, 0.9);
            padding: 8px 0;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
        }

        .marquee-text {
            white-space: nowrap;
            overflow: hidden;
            display: inline-block;
            animation: marquee 15s linear infinite;
            font-size: 0.9rem;
            color: #334155;
            font-weight: 500;
        }

        @keyframes marquee {
            0% {
                transform: translate(100%, 0);
            }

            100% {
                transform: translate(-100%, 0);
            }
        }

        .login-card-content {
            width: 100%;
            max-width: 400px;
            margin: 0 auto;
        }

        @media (max-width: 768px) {
            #login-page {
                flex-direction: column;
            }

            .login-image-section {
                display: none;
            }

            .login-form-section {
                flex: none;
                width: 100%;
                height: 100%;
                max-width: 100%;
                padding: 1.5rem;
            }
        }

        /* Components */
        .nav-menu {
            list-style: none;
            padding: 1rem;
        }

        .nav-link {
            display: flex;
            align-items: center;
            padding: 0.75rem 1rem;
            color: var(--text-muted);
            text-decoration: none;
            border-radius: 8px;
            margin-bottom: 5px;
            cursor: pointer;
        }

        .nav-link:hover,
        .nav-link.active {
            background: #eef2ff;
            color: var(--primary);
        }

        .nav-link svg {
            margin-right: 10px;
        }

        /* Tables */
        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
            background: white;
            font-size: 0.9rem;
        }

        .data-table th,
        .data-table td {
            border: 1px solid #cbd5e1;
            padding: 8px;
            text-align: center;
        }

        .data-table th {
            background: #f8fafc;
            font-weight: 600;
            white-space: nowrap;
        }

        /* Paper / Ijasah */
        .paper {
            background: white;
            width: 215mm;
            min-height: 330mm;
            padding: 10mm 15mm;
            margin: 0 auto;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
            color: black;
            font-family: 'Times New Roman', serif;
            position: relative;
            overflow: hidden;
        }

        .watermark-bg {
            position: absolute;
            top: 52%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 400px;
            height: 400px;
            opacity: 0.12;
            pointer-events: none;
            z-index: 0;
            filter: grayscale(100%);
            display: none;
            align-items: center;
            justify-content: center;
        }

        .show-watermark .watermark-bg {
            display: flex;
        }

        .watermark-bg img {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
        }

        .paper>div:not(.watermark-bg),
        .paper>table,
        .paper>h2,
        .paper>p {
            position: relative;
            z-index: 1;
        }

        .kop-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            padding-top: 5px;
            padding-bottom: 5px;
            margin-bottom: 2px;
        }

        .kop-line {
            border-top: 4px solid black;
            border-bottom: 1px solid black;
            height: 3px;
            width: 100%;
            margin-bottom: 20px;
        }

        #print-table-nilai {
            border: 1.5px solid black !important;
            color: black !important;
            background: transparent !important;
        }

        #print-table-nilai th {
            background-color: rgba(242, 242, 242, 0.8) !important;
            border: 1px solid black !important;
            color: black !important;
            padding: 8px;
        }

        #print-table-nilai td {
            background: transparent !important;
            border: 1px solid black !important;
            color: black !important;
            padding: 6px;
        }

        .kop-text {
            text-align: center;
            flex: 1;
        }

        .kop-logo img {
            width: 85px;
            height: 85px;
            object-fit: contain;
            margin-top: 10px;
        }

        .student-info-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
        }

        .student-info-table td {
            border: none;
            padding: 2px 5px;
            text-align: left;
            vertical-align: top;
        }

        /* Modals */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 200;
        }

        .modal-box {
            background: white;
            padding: 20px;
            border-radius: 12px;
            width: 95%;
            max-width: 800px;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .btn-close-modal {
            background: transparent;
            border: none;
            cursor: pointer;
            padding: 8px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #64748b;
            transition: all 0.2s;
        }

        .btn-close-modal:hover {
            background-color: #fee2e2;
            color: #ef4444;
            transform: rotate(90deg);
        }

        @media print {
            @page {
                size: portrait;
                margin: 0;
            }

            body,
            html {
                background: #fff !important;
                height: 100% !important;
                width: 100% !important;
                overflow: hidden !important;
                margin: 0;
                padding: 0;
            }

            #main-dashboard {
                display: block !important;
                height: 100% !important;
                width: 100% !important;
                overflow: hidden !important;
                position: absolute;
                top: 0;
                left: 0;
            }

            .sidebar,
            .top-header,
            .print-hidden,
            .btn-primary,
            .btn-action,
            #toast-container,
            #login-page {
                display: none !important;
            }

            .main-content,
            .page-container {
                padding: 0 !important;
                margin: 0 !important;
                width: 100% !important;
                height: 100% !important;
                display: block !important;
                overflow: hidden !important;
            }

            .page-view {
                display: none !important;
            }

            .page-view.active {
                display: block !important;
                width: 100% !important;
                height: 100% !important;
            }

            .paper {
                box-shadow: none !important;
                margin: 0 auto !important;
                padding: 10mm 15mm !important;
                width: 215mm !important;
                height: 330mm !important;
                max-height: 100% !important;
                border: none !important;
                -webkit-print-color-adjust: exact !important;
                print-color-adjust: exact !important;
                overflow: hidden !important;
                page-break-after: avoid !important;
                page-break-before: avoid !important;
            }

            #print-table-nilai th {
                background-color: #f2f2f2 !important;
            }
        }
    </style>
</head>

<body>
    <!-- Loading Overlay -->
    <div id="loading-overlay" class="hidden">
        <div class="spinner"></div>
        <div class="loading-text">Mohon Menunggu...</div>
    </div>
    <!-- Toast Container -->
    <div id="toast-container"></div>

    <!-- LOGIN -->
    <div id="login-page">
        <div class="login-image-section">
            <div class="marquee-container">
                <div class="marquee-text">Selamat Datang di Sistem Informasi Ijasah & Transkrip Nilai SMP Negeri 2
                    Wertamrian ‚Äî Pastikan data yang diinput valid dan benar.</div>
            </div>
            <img src="https://i.ibb.co.com/4yVLWDm/FORM-OK-THOMAS.png" alt="FORM-OK-THOMAS">
        </div>
        <div class="login-form-section">
            <div class="login-card-content" style="margin-top: -80px;">
                <h2 style="text-align: center; margin-bottom: 5px; font-size: 1.8rem; color: #1e293b;">SMPN 2 Wertamrian
                </h2>
                <p style="text-align: center; color: #64748b; margin-bottom: 25px; font-size: 1rem;">Sistem Informasi
                    Ijasah</p>
                <form onsubmit="handleLogin(event)">
                    <div class="form-group"><label>Username</label><input class="form-input" name="username" required>
                    </div>
                    <div class="form-group"><label>Password</label><input class="form-input" name="password"
                            type="password" required></div>
                    <button type="submit" class="btn-primary"
                        style="width:100%; padding: 12px; font-size: 1rem;">Masuk</button>
                </form>
                <div style="text-align: center; margin-top: 25px;">
                    <p style="font-size: 0.9rem; color: #64748b; margin-bottom: 5px;">Panduan penggunaan aplikasi:</p>
                    <a id="login-video-link" href="#" target="_blank"
                        style="display: none; color: #3b82f6; text-decoration: none; font-weight: 600; padding: 5px 10px; border: 1px dashed #3b82f6; border-radius: 4px;">üì∫
                        Tonton Video Panduan</a>
                    <span id="login-video-placeholder" style="display:none; font-size: 0.8rem; color: #94a3b8;">(Link
                        belum disetting)</span>
                </div>
                <div style="text-align: center; margin-top: 40px; border-top: 1px solid #e2e8f0; padding-top: 20px;">
                    <p style="font-size: 0.75rem; color: #94a3b8;">&copy; SMP Negeri 2 Wertamrian - OPS Andreas
                        Nusatjasi</p>
                </div>
            </div>
        </div>
    </div>

    <!-- DASHBOARD -->
    <div id="main-dashboard" class="hidden" style="display: flex; height: 100vh; width: 100%;">
        <!-- Sidebar -->
        <aside class="sidebar" id="app-sidebar">
            <div
                style="padding: 1.5rem; border-bottom: 1px solid #f1f5f9; display: flex; align-items: center; gap: 10px;">
                <div
                    style="width: 35px; height: 35px; background: var(--primary); border-radius: 8px; display: flex; align-items: center; justify-content: center; color: white;">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M22 10v6M2 10l10-5 10 5-10 5z" />
                        <path d="M6 12v5c0 2 2 3 6 3s6-1 6-3v-5" />
                    </svg>
                </div>
                <h2 style="font-size: 1.1rem; font-weight: 700;">SI IJASAH</h2>
            </div>
            <nav class="nav-menu">
                <a class="nav-link active" onclick="showPage('view-dashboard', this)">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#6366f1" stroke-width="2">
                        <rect x="3" y="3" width="7" height="7" />
                        <rect x="14" y="3" width="7" height="7" />
                        <rect x="14" y="14" width="7" height="7" />
                        <rect x="3" y="14" width="7" height="7" />
                    </svg>
                    <span>Dashboard</span>
                </a>
                <a class="nav-link" onclick="showPage('view-siswa', this)">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#10b981" stroke-width="2">
                        <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2" />
                        <circle cx="9" cy="7" r="4" />
                        <path d="M23 21v-2a4 4 0 0 0-3-3.87" />
                        <path d="M16 3.13a4 4 0 0 1 0 7.75" />
                    </svg>
                    <span>Data Siswa</span>
                </a>
                <a class="nav-link" onclick="showPage('view-ijasah', this)">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#f59e0b" stroke-width="2">
                        <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z" />
                        <path d="M14 2v6h6" />
                        <path d="M16 13H8" />
                        <path d="M16 17H8" />
                        <path d="M10 9H8" />
                    </svg>
                    <span>Preview Ijasah</span>
                </a>
                <a class="nav-link" onclick="showPage('view-upload-ijasah', this)">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#ec4899" stroke-width="2">
                        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" />
                        <polyline points="17 8 12 3 7 8" />
                        <line x1="12" y1="3" x2="12" y2="15" />
                    </svg>
                    <span>Upload Ijasah (OCR)</span>
                </a>
                <a class="nav-link" onclick="showPage('view-master', this)">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#8b5cf6" stroke-width="2">
                        <circle cx="12" cy="12" r="3" />
                        <path
                            d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z" />
                    </svg>
                    <span>Pengaturan Sekolah</span>
                </a>
            </nav>
            <div style="margin-top: auto; padding: 1rem; border-top: 1px solid #f1f5f9;">
                <button onclick="logout()" class="nav-link" style="width: 100%; border: none; background: none;">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#ef4444" stroke-width="2">
                        <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4" />
                        <polyline points="16 17 21 12 16 7" />
                        <line x1="21" y1="12" x2="9" y2="12" />
                    </svg>
                    <span>Keluar</span>
                </button>
                <div style="text-align: center; margin-top: 20px; padding-top: 15px; border-top: 1px dashed #e2e8f0;">
                    <p style="font-size: 0.7rem; color: #cbd5e1; line-height: 1.4;">SMP Negeri 2 Wertamrian<br>OPS
                        Andreas Nusatjasi</p>
                </div>
            </div>
        </aside>
        <!-- Main Content Area -->
        <main class="main-content">
            <!-- Top Header with Toggle -->
            <header class="top-header print-hidden">
                <button id="menu-toggle" onclick="toggleSidebar()">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="3" y1="12" x2="21" y2="12"></line>
                        <line x1="3" y1="6" x2="21" y2="6"></line>
                        <line x1="3" y1="18" x2="21" y2="18"></line>
                    </svg>
                </button>
                <h1 style="font-size: 1.25rem; font-weight: 600; color: var(--text-dark);" id="current-page-title">
                    Dashboard</h1>
            </header>
            <div class="page-container">
                <!-- DASHBOARD VIEW -->
                <div id="view-dashboard" class="page-view active">
                    <h2>Dashboard Overview</h2>
                    <div
                        style="margin-top: 20px; display: grid; gap: 20px; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));">
                        <div style="background: white; padding: 20px; border-radius: 12px; border: 1px solid #e2e8f0;">
                            <h3 style="color: #64748b; font-size: 0.9rem;">Total Siswa</h3>
                            <p style="font-size: 2rem; font-weight: bold; color: var(--primary);" id="dash-total-siswa">
                                0</p>
                        </div>
                        <div style="background: white; padding: 20px; border-radius: 12px; border: 1px solid #e2e8f0;">
                            <h3 style="color: #64748b; font-size: 0.9rem;">Status Sistem</h3>
                            <div style="display:flex; justify-content:space-between; align-items:center;">
                                <p
                                    style="font-size: 1.2rem; font-weight: bold; color: var(--success); margin-top: 5px;">
                                    Online</p>
                                <button onclick="checkDatabaseConnection()"
                                    style="font-size: 0.8rem; padding: 4px 8px; border: 1px solid #cbd5e1; background: #f8fafc; border-radius: 4px; cursor: pointer;">Cek
                                    Koneksi</button>
                            </div>
                        </div>
                    </div>
                    <!-- Ranking Table Section -->
                    <div
                        style="background: white; padding: 25px; border-radius: 12px; border: 1px solid #e2e8f0; margin-top: 25px;">
                        <h3
                            style="margin-bottom: 20px; color: var(--primary); display: flex; align-items: center; gap: 8px;">
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                stroke-width="2">
                                <polygon
                                    points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2">
                                </polygon>
                            </svg>
                            Peringkat 10 Besar Nilai Rata-Rata Tertinggi
                        </h3>
                        <div style="overflow-x: auto;">
                            <table class="data-table" style="width: 100%;">
                                <thead>
                                    <tr>
                                        <th style="width: 80px; text-align: center;">Peringkat</th>
                                        <th>Nama Siswa</th>
                                        <th>NISN</th>
                                        <th style="text-align: center;">Total Nilai</th>
                                        <th style="text-align: center;">Nilai Rata-Rata</th>
                                    </tr>
                                </thead>
                                <tbody id="ranking-table-body">
                                    <tr>
                                        <td colspan="5" style="text-align:center;">Memuat data...</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                <!-- SISWA VIEW -->
                <div id="view-siswa" class="page-view">
                    <div
                        style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; flex-wrap: wrap; gap: 10px;">
                        <h2>Data Kelulusan Siswa</h2>
                        <div style="display: flex; gap: 10px;">
                            <button class="btn-primary" style="width: auto; background: #10b981;"
                                onclick="openModal('modal-siswa')">+ Tambah Siswa</button>
                            <button class="btn-primary" style="width: auto; background: #3b82f6;"
                                onclick="downloadTemplate()">Download Template</button>
                            <button class="btn-primary" style="width: auto; background: #f59e0b;"
                                onclick="triggerImport()">Import Data</button>
                            <input type="file" id="import-file" style="display:none" onchange="handleFileImport(this)"
                                accept=".xlsx, .xls">
                            <button class="btn-primary" style="width: auto;" onclick="loadSiswaData(true)">Refresh
                                Data</button>
                        </div>
                    </div>
                    <!-- Search & Filter Bar -->
                    <div
                        style="background: white; padding: 15px; border-radius: 8px; border: 1px solid #e2e8f0; margin-bottom: 15px; display: flex; gap: 15px; align-items: center; flex-wrap: wrap;">
                        <div style="flex: 1; min-width: 250px; position:relative;">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#94a3b8"
                                stroke-width="2" style="position: absolute; left: 10px; top: 10px;">
                                <circle cx="11" cy="11" r="8"></circle>
                                <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
                            </svg>
                            <input type="text" id="search-siswa" placeholder="Cari Nama, NISN, atau No Ijasah..."
                                class="form-input" style="margin:0; padding-left: 35px;" onkeyup="filterSiswa()">
                        </div>
                        <div style="width: 220px;">
                            <select id="filter-siswa" class="form-input" style="margin:0; cursor:pointer;"
                                onchange="filterSiswa()">
                                <option value="all">Semua Data</option>
                                <option value="duplicates">‚ö†Ô∏è Hanya Duplikat</option>
                                <option value="rank_high">üèÜ Nilai Tertinggi</option>
                                <option value="rank_low">üìâ Nilai Terendah</option>
                                <option value="incomplete">üìù Data Belum Lengkap</option>
                            </select>
                        </div>
                    </div>
                    <div style="overflow-x: auto;">
                        <table class="data-table" id="table-siswa">
                            <thead>
                                <tr>
                                    <th>No</th>
                                    <th>NISN</th>
                                    <th>Nama Lengkap</th>
                                    <th>Tempat, Tgl Lahir</th>
                                    <th>No Ijasah</th>
                                    <th>Tgl Ijasah</th>
                                    <th>Agm</th>
                                    <th>PKN</th>
                                    <th>Indo</th>
                                    <th>MTK</th>
                                    <th>IPA</th>
                                    <th>IPS</th>
                                    <th>Ing</th>
                                    <th>Seni</th>
                                    <th>PJOK</th>
                                    <th>Info</th>
                                    <th>Ktrm</th>
                                    <th>Mlk</th>
                                    <th>Rata</th>
                                    <th>Aksi</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
                <!-- IJASAH VIEW -->
                <div id="view-ijasah" class="page-view">
                    <div style="display: flex; gap: 10px; margin-bottom: 20px; align-items: center;"
                        class="print-hidden">
                        <button onclick="showPage('view-siswa')" class="btn-primary"
                            style="width: auto; background: var(--secondary);">Kembali</button>
                        <button onclick="toggleWatermark()" id="btn-toggle-watermark" class="btn-primary"
                            style="width: auto; background: #64748b;">Gunakan Background</button>
                        <button onclick="window.print()" class="btn-primary" style="width: auto;">Print Halaman
                            Ini</button>
                        <button onclick="printAllSiswa()" class="btn-primary"
                            style="width: auto; background: #8b5cf6; margin-left: auto;">üñ®Ô∏è Cetak Semua
                            Transkrip</button>
                    </div>
                    <div id="bulk-print-container" class="hidden"></div>
                    <div id="single-print-container">
                        <div class="paper">
                            <div class="watermark-bg">
                                <img id="print-watermark" src="">
                            </div>
                            <!-- Kop Surat -->
                            <div class="kop-header">
                                <div class="kop-logo">
                                    <img id="logo-kiri" src="" referrerpolicy="no-referrer">
                                </div>
                                <div class="kop-text">
                                    <h3 style="margin:0; font-size:14pt; font-weight:bold;">PEMERINTAH KABUPATEN
                                        KEPULAUAN TANIMBAR</h3>
                                    <h3 style="margin:0; font-size:14pt; font-weight:bold;">DINAS PENDIDIKAN DAN
                                        KEBUDAYAAN</h3>
                                    <h2 style="margin:0; font-size:18pt; font-weight:bold;" id="print-nama-sekolah">...
                                    </h2>
                                    <h3 style="margin:0; font-size:14pt; font-weight:bold;">ARUI BAB</h3>
                                    <p style="margin:0; font-size:11pt;" id="print-alamat">Jln.Trans Yamdena Kode Pos.
                                        97664</p>
                                </div>
                                <div class="kop-logo">
                                    <img id="logo-kanan" src="" referrerpolicy="no-referrer">
                                </div>
                            </div>
                            <div class="kop-line"></div>
                            <h2 style="text-align: center; margin-top: 20px; font-size: 14pt; margin-bottom: 5px;">
                                TRANSKRIP NILAI</h2>
                            <p style="text-align: center; margin-bottom: 25px;" id="print-no-surat">Nomor: ...</p>
                            <table class="student-info-table">
                                <tr>
                                    <td style="width: 280px; white-space: nowrap;">Satuan Pendidikan</td>
                                    <td style="width:10px">:</td>
                                    <td id="print-sekolah-asal">...</td>
                                </tr>
                                <tr>
                                    <td style="white-space: nowrap;">Nomor Pokok Satuan Pendidikan</td>
                                    <td>:</td>
                                    <td id="print-npsn-text">...</td>
                                </tr>
                                <tr>
                                    <td>Nama Lengkap</td>
                                    <td>:</td>
                                    <td id="print-nama-siswa">...</td>
                                </tr>
                                <tr>
                                    <td>Tempat dan Tanggal Lahir</td>
                                    <td>:</td>
                                    <td id="print-ttl">...</td>
                                </tr>
                                <tr>
                                    <td>Nomor Induk Siswa Nasional</td>
                                    <td>:</td>
                                    <td id="print-nisn-view">...</td>
                                </tr>
                                <tr>
                                    <td>Nomor Ijasah</td>
                                    <td>:</td>
                                    <td id="print-no-ijasah">...</td>
                                </tr>
                                <tr>
                                    <td>Tanggal Kelulusan</td>
                                    <td>:</td>
                                    <td id="print-tgl-ijasah">...</td>
                                </tr>
                            </table>
                            <table class="data-table" id="print-table-nilai">
                                <thead>
                                    <tr>
                                        <th>No</th>
                                        <th>Mata Pelajaran</th>
                                        <th>Nilai</th>
                                    </tr>
                                </thead>
                                <tbody></tbody>
                            </table>
                            <div style="margin-top: 30px; display: flex; justify-content: flex-end;">
                                <div style="width: 350px; text-align: left;">
                                    <p id="print-ttd-full" style="margin-bottom: 2px; white-space: nowrap;">...</p>
                                    <p id="print-label-kepsek" style="white-space: nowrap;">Kepala Sekolah,</p>
                                    <br><br><br>
                                    <p style="text-decoration: underline; font-weight: bold;" id="print-kepsek">...</p>
                                    <p>NIP. <span id="print-nip">...</span></p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- UPLOAD IJASAH OCR VIEW -->
                <div id="view-upload-ijasah" class="page-view">
                    <!-- ARSIP SECTION -->
                    <div
                        style="background: white; padding: 25px; border-radius: 12px; border: 1px solid #e2e8f0; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); margin-bottom: 20px;">
                        <h2
                            style="margin-bottom: 15px; display: flex; align-items: center; gap: 10px; color: var(--primary);">
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                stroke-width="2">
                                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                                <polyline points="17 8 12 3 7 8"></polyline>
                                <line x1="12" y1="3" x2="12" y2="15"></line>
                            </svg>
                            Arsip & Upload Ijasah
                        </h2>
                        <div
                            style="margin-bottom: 20px; padding: 20px; background: #eef2ff; border-radius: 12px; border: 1px solid #c7d2fe; display: flex; flex-direction: column; align-items: center; text-align: center;">
                            <h3 style="color: #4338ca; margin-bottom: 10px;">Blangko / Arsip Ijasah</h3>
                            <p style="color: #6366f1; margin-bottom: 15px; font-size: 0.9rem;">Klik tombol di bawah
                                untuk melihat arsip ijasah yang tersimpan di Supabase Storage.</p>
                            <a href="#" id="btn-lihat-blangko" target="_blank" class="btn-primary"
                                style="background: #f59e0b; text-decoration: none; padding: 12px 24px; font-size: 1rem; display: inline-flex; align-items: center; gap: 8px; box-shadow: 0 4px 6px rgba(245, 158, 11, 0.3);">
                                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                    stroke-width="2">
                                    <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path>
                                    <circle cx="12" cy="12" r="3"></circle>
                                </svg>
                                Lihat File Ijasah
                            </a>
                        </div>
                        <hr style="border: 0; border-top: 1px solid #e2e8f0; margin: 20px 0;">
                        <p style="color: #64748b; margin-bottom: 10px; font-weight: 600;">Upload Arsip Baru</p>
                        <div style="display: flex; gap: 10px; align-items: flex-end; flex-wrap: wrap;">
                            <div style="flex: 1; min-width: 250px;">
                                <input type="file" id="arsip-upload-input" class="form-input" style="margin-top:0;">
                            </div>
                            <button class="btn-primary" onclick="uploadArsipFile()" style="height: 42px;">Upload ke
                                Storage</button>
                        </div>
                        <p style="font-size: 0.8rem; color: #94a3b8; margin-top: 5px;">*Proses upload mungkin memerlukan
                            waktu beberapa saat tergantung ukuran file.</p>
                        <div id="arsip-result" class="hidden"
                            style="margin-top: 15px; padding: 15px; background: #ecfdf5; border-radius: 8px; border: 1px solid #10b981;">
                            <p style="margin:0; color: #065f46; font-weight: 600; text-align: center;">‚úÖ Upload Berhasil
                                Disimpan!</p>
                        </div>
                    </div>
                    <!-- OCR SECTION -->
                    <div
                        style="background: white; padding: 25px; border-radius: 12px; border: 1px solid #e2e8f0; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1);">
                        <h2 style="margin-bottom: 10px; display: flex; align-items: center; gap: 10px;">
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                stroke-width="2">
                                <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                                <polyline points="14 2 14 8 20 8"></polyline>
                                <line x1="16" y1="13" x2="8" y2="13"></line>
                                <line x1="16" y1="17" x2="8" y2="17"></line>
                                <polyline points="10 9 9 9 8 9"></polyline>
                            </svg>
                            Upload File Ijasah (PDF / Gambar)
                        </h2>
                        <p style="color: #64748b; margin-bottom: 25px;">Sistem akan mendeteksi seluruh Nama Siswa dan
                            Nomor Ijasah dari file PDF atau Gambar secara otomatis.</p>
                        <div style="border: 2px dashed #cbd5e1; padding: 40px; border-radius: 12px; text-align: center; background: #f8fafc; transition: 0.3s;"
                            id="drop-zone-ocr">
                            <input type="file" id="ocr-upload-input" style="display:none" accept="image/*,.pdf"
                                onchange="processIjasahOCR(this)">
                            <div style="margin-bottom: 15px;">
                                <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="#94a3b8"
                                    stroke-width="2">
                                    <rect x="3" y="3" width="18" height="18" rx="2" ry="2" />
                                    <circle cx="8.5" cy="8.5" r="1.5" />
                                    <polyline points="21 15 16 10 5 21" />
                                </svg>
                            </div>
                            <button class="btn-primary"
                                onclick="document.getElementById('ocr-upload-input').click()">Pilih PDF /
                                Gambar</button>
                            <p style="margin-top: 10px; font-size: 0.875rem; color: #94a3b8;">Format: PDF (Satu/Banyak
                                Halaman), JPG, PNG</p>
                        </div>
                        <div id="ocr-results-container" class="hidden" style="margin-top: 30px;">
                            <h3 style="margin-bottom: 15px;">Hasil Deteksi</h3>
                            <div style="overflow-x: auto;">
                                <table class="data-table">
                                    <thead>
                                        <tr>
                                            <th>Siswa</th>
                                            <th>Hasil Deteksi</th>
                                            <th>Status</th>
                                        </tr>
                                    </thead>
                                    <tbody id="ocr-results-body"></tbody>
                                </table>
                            </div>
                            <div style="margin-top: 20px; display: flex; gap: 10px; justify-content: flex-end;">
                                <button class="btn-primary" style="background: var(--secondary);"
                                    onclick="resetOCR()">Reset</button>
                                <button id="btn-save-ocr" class="btn-primary" onclick="saveOCRResult()">Simpan ke
                                    Database</button>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- MASTER VIEW -->
                <div id="view-master" class="page-view">
                    <div style="background: white; padding: 20px; border-radius: 12px; border: 1px solid #e2e8f0;">
                        <div
                            style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                            <h3>Data & Konfigurasi Sekolah</h3>
                            <button onclick="editSekolah()" class="btn-primary" style="width: auto;">Edit
                                Konfigurasi</button>
                        </div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                            <div>
                                <p><strong>Nama Sekolah:</strong> <span id="master-nama-sekolah">-</span></p>
                                <p><strong>NPSN:</strong> <span id="master-npsn">-</span></p>
                                <p><strong>Kepala Sekolah:</strong> <span id="master-kepsek">-</span></p>
                                <p><strong>NIP:</strong> <span id="master-nip">-</span></p>
                                <p><strong>Jabatan TTD:</strong> <span id="master-jabatan">-</span></p>
                                <p><strong>Tanggal TTD:</strong> <span id="master-tgl-ttd">-</span></p>
                                <p><strong>Nomor Surat:</strong> <span id="master-no-surat">-</span></p>
                                <p><strong>Link Video Panduan:</strong> <a id="master-video-link" href="#"
                                        target="_blank" style="color:blue;">-</a></p>
                            </div>
                            <div style="display: flex; gap: 15px;">
                                <div style="text-align:center">
                                    <p style="margin-bottom:5px; font-weight:bold; font-size:0.8rem;">Logo Kiri</p>
                                    <div
                                        style="width: 100px; height: 100px; border: 1px dashed #ccc; display:flex; align-items:center; justify-content:center; background:#f8fafc; overflow:hidden;">
                                        <img id="master-logo-kiri"
                                            style="max-width: 100%; max-height: 100%; object-fit: contain; display:none;"
                                            onload="this.style.display='block'">
                                        <span id="placeholder-kiri" style="font-size:0.7rem; color:#ccc;">No Logo</span>
                                    </div>
                                    <label class="btn-primary"
                                        style="font-size: 0.7rem; width: auto; margin-top: 5px; padding: 5px 10px; cursor: pointer; display:inline-block;">Ganti<input
                                            type="file" onchange="uploadLogo(this, 'kiri')"
                                            style="display:none;"></label>
                                </div>
                                <div style="text-align:center">
                                    <p style="margin-bottom:5px; font-weight:bold; font-size:0.8rem;">Logo Kanan</p>
                                    <div
                                        style="width: 100px; height: 100px; border: 1px dashed #ccc; display:flex; align-items:center; justify-content:center; background:#f8fafc; overflow:hidden;">
                                        <img id="master-logo-kanan"
                                            style="max-width: 100%; max-height: 100%; object-fit: contain; display:none;"
                                            onload="this.style.display='block'">
                                        <span id="placeholder-kanan" style="font-size:0.7rem; color:#ccc;">No
                                            Logo</span>
                                    </div>
                                    <label class="btn-primary"
                                        style="font-size: 0.7rem; width: auto; margin-top: 5px; padding: 5px 10px; cursor: pointer; display:inline-block;">Ganti<input
                                            type="file" onchange="uploadLogo(this, 'kanan')"
                                            style="display:none;"></label>
                                </div>
                                <div style="text-align:center">
                                    <p style="margin-bottom:5px; font-weight:bold; font-size:0.8rem;">Watermark</p>
                                    <div
                                        style="width: 100px; height: 100px; border: 1px dashed #ccc; display:flex; align-items:center; justify-content:center; background:#f8fafc; overflow:hidden;">
                                        <img id="master-logo-watermark"
                                            style="max-width: 100%; max-height: 100%; object-fit: contain; display:none;"
                                            onload="this.style.display='block'">
                                        <span id="placeholder-watermark" style="font-size:0.7rem; color:#ccc;">No
                                            Logo</span>
                                    </div>
                                    <label class="btn-primary"
                                        style="font-size: 0.7rem; width: auto; margin-top: 5px; padding: 5px 10px; cursor: pointer; display:inline-block;">Ganti<input
                                            type="file" onchange="uploadLogo(this, 'watermark')"
                                            style="display:none;"></label>
                                </div>
                            </div>
                        </div>
                    </div>
                    <!-- MAPEL TABLE -->
                    <div
                        style="background: white; padding: 20px; border-radius: 8px; border: 1px solid #e2e8f0; margin-top: 20px;">
                        <div style="display:flex; justify-content:space-between; align-items:center;">
                            <h3>Data Mata Pelajaran</h3>
                            <button onclick="openModal('modal-mapel')" class="btn-primary" style="width: auto;">+
                                Mapel</button>
                        </div>
                        <table class="data-table" id="table-mapel">
                            <thead>
                                <tr>
                                    <th>No Urut</th>
                                    <th>Nama Mapel</th>
                                    <th>Kelompok</th>
                                    <th>Aksi</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Modal Siswa -->
    <div id="modal-siswa" class="hidden modal-overlay">
        <div class="modal-box">
            <div class="modal-header">
                <h3>Data Siswa</h3>
                <button class="btn-close-modal" onclick="closeModal('modal-siswa')" title="Tutup">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                        stroke-linecap="round" stroke-linejoin="round">
                        <line x1="18" y1="6" x2="6" y2="18"></line>
                        <line x1="6" y1="6" x2="18" y2="18"></line>
                    </svg>
                </button>
            </div>
            <form onsubmit="saveSiswa(event)">
                <input type="hidden" name="id">
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                    <div class="form-group"><label>Nama Lengkap</label><input class="form-input" name="nama_lengkap"
                            required></div>
                    <div class="form-group"><label>NISN</label><input class="form-input" name="nisn" required></div>
                    <div class="form-group"><label>Tempat Lahir</label><input class="form-input" name="tempat_lahir">
                    </div>
                    <div class="form-group"><label>Tanggal Lahir</label><input class="form-input" name="tanggal_lahir">
                    </div>
                    <div class="form-group"><label>No Ijasah</label><input class="form-input" name="no_ijasah"></div>
                    <div class="form-group"><label>Tanggal Kelulusan (Lulus)</label><input class="form-input"
                            name="tgl_lulus"></div>
                </div>
                <h4>Nilai</h4>
                <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px;">
                    <div class="form-group"><label>Agama</label><input class="form-input" name="agama"></div>
                    <div class="form-group"><label>PKN</label><input class="form-input" name="pkn"></div>
                    <div class="form-group"><label>Bindo</label><input class="form-input" name="bindo"></div>
                    <div class="form-group"><label>MTK</label><input class="form-input" name="mtk"></div>
                    <div class="form-group"><label>IPA</label><input class="form-input" name="ipa"></div>
                    <div class="form-group"><label>IPS</label><input class="form-input" name="ips"></div>
                    <div class="form-group"><label>B.Inggris</label><input class="form-input" name="bing"></div>
                    <div class="form-group"><label>Informatika</label><input class="form-input" name="informatika">
                    </div>
                    <div class="form-group"><label>Seni Budaya</label><input class="form-input" name="seni"></div>
                    <div class="form-group"><label>Penjasorkes</label><input class="form-input" name="penjas"></div>
                    <div class="form-group"><label>Ketrampilan</label><input class="form-input" name="ketrampilan">
                    </div>
                    <div class="form-group"><label>Mulok</label><input class="form-input" name="mulok"></div>
                </div>
                <button type="submit" class="btn-primary">Simpan</button>
            </form>
        </div>
    </div>

    <!-- Modal Sekolah -->
    <div id="modal-sekolah" class="hidden modal-overlay">
        <div class="modal-box">
            <div class="modal-header">
                <h3>Edit Sekolah</h3>
                <button class="btn-close-modal" onclick="closeModal('modal-sekolah')" title="Tutup">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                        stroke-linecap="round" stroke-linejoin="round">
                        <line x1="18" y1="6" x2="6" y2="18"></line>
                        <line x1="6" y1="6" x2="18" y2="18"></line>
                    </svg>
                </button>
            </div>
            <form onsubmit="saveSekolah(event)">
                <div class="form-group"><label>Nama Sekolah</label><input class="form-input" name="nama_sekolah"></div>
                <div class="form-group"><label>NPSN</label><input class="form-input" name="npsn"></div>
                <div class="form-group"><label>Kepala Sekolah</label><input class="form-input" name="nama_kepsek"></div>
                <div class="form-group"><label>NIP</label><input class="form-input" name="nip_kepsek"></div>
                <div class="form-group"><label>Jabatan Penandatangan (Contoh: Kepala SMPN 2)</label><input
                        class="form-input" name="jabatan_kepsek"></div>
                <div class="form-group"><label>Nomor Surat</label><input class="form-input" name="no_surat"></div>
                <div class="form-group"><label>Kota TTD</label><input class="form-input" name="kota_ttd"></div>
                <div class="form-group"><label>Tanggal TTD</label><input class="form-input" name="tgl_ttd"
                        placeholder="Contoh: 16 Juni 2025"></div>
                <div class="form-group"><label>Link Video Panduan (Youtube/Drive)</label><input class="form-input"
                        name="link_video_panduan"></div>
                <button type="submit" class="btn-primary">Simpan</button>
            </form>
        </div>
    </div>

    <!-- Logout Confirmation Modal -->
    <div id="modal-logout" class="hidden modal-overlay" style="z-index: 9999;">
        <div class="modal-box" style="max-width: 400px; text-align: center; padding: 30px; border-radius: 16px;">
            <div style="margin-bottom: 20px;">
                <div
                    style="width: 70px; height: 70px; background: #fee2e2; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);">
                    <svg width="36" height="36" viewBox="0 0 24 24" fill="none" stroke="#ef4444" stroke-width="2"
                        stroke-linecap="round" stroke-linejoin="round">
                        <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path>
                        <polyline points="16 17 21 12 16 7"></polyline>
                        <line x1="21" y1="12" x2="9" y2="12"></line>
                    </svg>
                </div>
            </div>
            <h3 style="font-size: 1.4rem; margin-bottom: 10px; color: #1e293b; font-weight: 700;">Konfirmasi Keluar</h3>
            <p style="color: #64748b; margin-bottom: 30px; font-size: 1rem; line-height: 1.5;">Apakah Anda yakin ingin
                mengakhiri sesi dan keluar dari aplikasi?</p>
            <div style="display: flex; gap: 15px; justify-content: center;">
                <button onclick="closeModal('modal-logout')" class="btn-primary"
                    style="background: #f1f5f9; color: #475569; width: auto; flex: 1; border: 1px solid #cbd5e1;">Batal</button>
                <button onclick="confirmLogout()" class="btn-primary"
                    style="background: #ef4444; width: auto; flex: 1; border: 1px solid #ef4444; box-shadow: 0 4px 6px -1px rgba(239, 68, 68, 0.3);">Ya,
                    Keluar</button>
            </div>
        </div>
    </div>

    <!-- Modal Mapel -->
    <div id="modal-mapel" class="hidden modal-overlay">
        <div class="modal-box">
            <div class="modal-header">
                <h3>Data Mapel</h3>
                <button class="btn-close-modal" onclick="closeModal('modal-mapel')" title="Tutup">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                        stroke-linecap="round" stroke-linejoin="round">
                        <line x1="18" y1="6" x2="6" y2="18"></line>
                        <line x1="6" y1="6" x2="18" y2="18"></line>
                    </svg>
                </button>
            </div>
            <form onsubmit="saveMapel(event)">
                <input type="hidden" name="id">
                <div class="form-group"><label>Nomor Urut</label><input class="form-input" name="no_urut" required>
                </div>
                <div class="form-group"><label>Nama Mata Pelajaran</label><input class="form-input" name="nama_mapel"
                        required></div>
                <div class="form-group"><label>Kelompok (A/B/C)</label><input class="form-input" name="kelompok"></div>
                <button type="submit" class="btn-primary">Simpan</button>
            </form>
        </div>
    </div>

    <!-- Modal Debug Info -->
    <div id="modal-debug" class="hidden modal-overlay">
        <div class="modal-box">
            <div class="modal-header">
                <h3>Status Database</h3>
                <button class="btn-close-modal" onclick="closeModal('modal-debug')" title="Tutup">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                        stroke-linecap="round" stroke-linejoin="round">
                        <line x1="18" y1="6" x2="6" y2="18"></line>
                        <line x1="6" y1="6" x2="18" y2="18"></line>
                    </svg>
                </button>
            </div>
            <div id="debug-content"
                style="white-space: pre-wrap; font-family: monospace; background: #f1f5f9; padding: 15px; border-radius: 8px; font-size: 0.9rem;">
                Memeriksa...</div>
            <div style="margin-top: 15px; font-size: 0.85rem; color: #64748b;">
                *Pastikan konfigurasi Supabase sudah benar.
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.4.2/mammoth.browser.min.js"></script>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    <script>
        // ============================================
        // APP STATE & INITIALIZATION
        // ============================================
        const app = {
            isLoggedIn: false,
            config: {},
            mapelList: [],
            siswaData: [],

            init: function () {
                console.log('üöÄ App initializing...');
                console.log('Supabase URL:', SUPABASE_URL);
                console.log('Supabase initialized:', supabase !== null);

                try {
                    if (sessionStorage.getItem('auth') === '1') {
                        this.showDashboard();
                    } else {
                        this.showLogin();
                    }
                } catch (e) {
                    console.error("Init error:", e);
                    this.showLogin();
                }
            },

            showLogin: function () {
                const login = document.getElementById('login-page');
                const dash = document.getElementById('main-dashboard');
                if (login) {
                    login.classList.remove('hidden');
                    login.style.display = 'flex';
                }
                if (dash) {
                    dash.classList.add('hidden');
                    dash.style.display = 'none';
                }
            },

            showDashboard: function () {
                const loader = document.getElementById('loading-overlay');
                if (loader) loader.classList.remove('hidden');
                const dash = document.getElementById('main-dashboard');
                const login = document.getElementById('login-page');

                if (dash) {
                    dash.classList.remove('hidden');
                    dash.style.setProperty('display', 'flex', 'important');
                    dash.style.opacity = '1';
                }
                if (login) {
                    login.classList.add('hidden');
                    login.style.setProperty('display', 'none', 'important');
                }

                showPage('view-dashboard', document.querySelector('.nav-link'));

                setTimeout(() => {
                    this.loadConfig();
                    loadSiswaData();
                    if (loader) loader.classList.add('hidden');
                }, 500);
            },

            loadConfig: async function () {
                if (!supabase) {
                    console.error('Supabase not initialized');
                    return;
                }
                try {
                    const { data, error } = await supabase.from('config').select('*');
                    if (error) throw error;

                    const cfg = {};
                    data.forEach(row => {
                        cfg[row.key] = row.value;
                    });

                    this.config = cfg;
                    this.renderConfig();

                    // Load Mapel
                    const { data: mapelData, error: mapelError } = await supabase.from('mapel').select('*').order('no_urut', { ascending: true });
                    if (!mapelError) {
                        this.mapelList = mapelData || [];
                    }
                } catch (e) {
                    console.error("Load config error:", e);
                    showToast('Gagal memuat konfigurasi: ' + e.message, 'error');
                }
            },

            renderConfig: function () {
                const c = this.config;
                if (!c) return;
                try {
                    ['master-nama-sekolah', 'print-nama-sekolah'].forEach(id => {
                        if (document.getElementById(id) && c.nama_sekolah) document.getElementById(id).innerText = c.nama_sekolah;
                    });
                    ['master-npsn', 'print-npsn-text'].forEach(id => {
                        if (document.getElementById(id) && c.npsn) document.getElementById(id).innerText = c.npsn;
                    });
                    ['master-kepsek', 'print-kepsek'].forEach(id => {
                        if (document.getElementById(id) && c.nama_kepsek) document.getElementById(id).innerText = c.nama_kepsek;
                    });
                    ['master-nip', 'print-nip'].forEach(id => {
                        if (document.getElementById(id) && c.nip_kepsek) document.getElementById(id).innerText = c.nip_kepsek;
                    });
                    if (c.kota_ttd || c.tgl_ttd) {
                        const full = (c.kota_ttd || '') + (c.kota_ttd && c.tgl_ttd ? ', ' : '') + (c.tgl_ttd || '');
                        const el = document.getElementById('print-ttd-full');
                        if (el) el.innerText = full;
                    }
                    if (c.tgl_ttd && document.getElementById('master-tgl-ttd')) {
                        document.getElementById('master-tgl-ttd').innerText = c.tgl_ttd;
                    }
                    if (c.jabatan_kepsek && document.getElementById('master-jabatan')) {
                        document.getElementById('master-jabatan').innerText = c.jabatan_kepsek;
                    }
                    if (c.jabatan_kepsek) {
                        const label = document.getElementById('print-label-kepsek');
                        if (label) label.innerText = c.jabatan_kepsek + ",";
                    } else if (c.nama_sekolah) {
                        const label = document.getElementById('print-label-kepsek');
                        if (label) label.innerText = "Kepala " + c.nama_sekolah + ",";
                    }
                    if (c.no_surat) {
                        document.getElementById('print-no-surat').innerText = "Nomor: " + c.no_surat;
                        if (document.getElementById('master-no-surat')) document.getElementById('master-no-surat').innerText = c.no_surat;
                    }

                    // Logos from Supabase Storage
                    if (supabase) {
                        const storageUrl = supabase.storage.from('logos').getPublicUrl;

                        if (c.logo_kiri) {
                            const { data: { publicUrl } } = storageUrl('logo_kiri');
                            const previewImg = document.getElementById('logo-kiri');
                            if (previewImg) {
                                previewImg.src = publicUrl;
                                previewImg.style.display = 'block';
                            }
                            const masterImg = document.getElementById('master-logo-kiri');
                            if (masterImg) {
                                masterImg.src = publicUrl;
                                masterImg.style.display = 'block';
                                const placeholder = document.getElementById('placeholder-kiri');
                                if (placeholder) placeholder.style.display = 'none';
                            }
                        }

                        if (c.logo_kanan) {
                            const { data: { publicUrl } } = storageUrl('logo_kanan');
                            const previewImg = document.getElementById('logo-kanan');
                            if (previewImg) {
                                previewImg.src = publicUrl;
                                previewImg.style.display = 'block';
                            }
                            const masterImg = document.getElementById('master-logo-kanan');
                            if (masterImg) {
                                masterImg.src = publicUrl;
                                masterImg.style.display = 'block';
                                const placeholder = document.getElementById('placeholder-kanan');
                                if (placeholder) placeholder.style.display = 'none';
                            }
                        }

                        if (c.logo_watermark) {
                            const { data: { publicUrl } } = storageUrl('logo_watermark');
                            const masterImg = document.getElementById('master-logo-watermark');
                            if (masterImg) {
                                masterImg.src = publicUrl;
                                masterImg.style.display = 'block';
                                const placeholder = document.getElementById('placeholder-watermark');
                                if (placeholder) placeholder.style.display = 'none';
                            }
                            const printWatermark = document.getElementById('print-watermark');
                            if (printWatermark) printWatermark.src = publicUrl;
                        }
                    }

                    // Watermark state
                    const localState = localStorage.getItem('watermarkState');
                    const showWatermark = localState !== null ? (localState === 'true') : (String(c.show_watermark).toLowerCase() === 'true');
                    if (showWatermark) {
                        document.querySelector('.paper').classList.add('show-watermark');
                        const btn = document.getElementById('btn-toggle-watermark');
                        if (btn) {
                            btn.innerText = 'Watermark: ON';
                            btn.style.background = '#10b981';
                        }
                    } else {
                        document.querySelector('.paper').classList.remove('show-watermark');
                        const btn = document.getElementById('btn-toggle-watermark');
                        if (btn) {
                            btn.innerText = 'Watermark: OFF';
                            btn.style.background = '#ef4444';
                        }
                    }

                    // Video link
                    if (c.link_video_panduan) {
                        const link = document.getElementById('login-video-link');
                        if (link) {
                            link.href = c.link_video_panduan;
                            link.style.display = 'inline-block';
                        }
                        const placeholder = document.getElementById('login-video-placeholder');
                        if (placeholder) placeholder.style.display = 'none';
                        const masterLink = document.getElementById('master-video-link');
                        if (masterLink) {
                            masterLink.href = c.link_video_panduan;
                            masterLink.innerText = c.link_video_panduan;
                        }
                    }
                } catch (e) {
                    console.error("Render config error:", e);
                }
            },

            getSiswa: function (id) {
                return this.siswaData.find(s => s.id === id);
            }
        };

        // Initialize app
        document.addEventListener('DOMContentLoaded', () => {
            // Wait for Supabase to initialize
            setTimeout(() => {
                app.init();
            }, 100);
        });

        // ============================================
        // AUTHENTICATION
        // ============================================
        async function handleLogin(e) {
            e.preventDefault();
            const form = e.target;
            const username = form.username.value;
            const password = form.password.value;

            const btn = form.querySelector('button[type="submit"]');
            const originalText = btn.innerText;
            btn.innerText = 'Memverifikasi...';
            btn.disabled = true;

            try {
                if (!supabase) {
                    throw new Error('Supabase tidak terinisialisasi');
                }

                const { data, error } = await supabase
                    .from('users')
                    .select('*')
                    .eq('username', username)
                    .eq('password', password)
                    .single();

                if (error || !data) {
                    btn.innerText = originalText;
                    btn.disabled = false;
                    showToast('Username atau Password salah!', 'error');
                    return;
                }

                sessionStorage.setItem('auth', '1');
                sessionStorage.setItem('user_id', data.id);

                showToast('Login Berhasil!', 'success');
                setTimeout(() => {
                    app.showDashboard();
                }, 500);
            } catch (err) {
                btn.innerText = originalText;
                btn.disabled = false;
                showToast("Error: " + err.message, 'error');
            }
        }

        function logout() {
            openModal('modal-logout');
        }

        async function confirmLogout() {
            closeModal('modal-logout');
            const loader = document.getElementById('loading-overlay');
            if (loader) {
                loader.classList.remove('hidden');
                loader.querySelector('.loading-text').innerText = 'Keluar Sistem...';
            }

            setTimeout(async () => {
                sessionStorage.removeItem('auth');
                sessionStorage.removeItem('user_id');
                if (supabase) {
                    await supabase.auth.signOut();
                }
                app.showLogin();
                if (loader) loader.classList.add('hidden');
                const sb = document.getElementById('app-sidebar');
                if (sb) {
                    sb.classList.remove('mobile-open');
                    sb.classList.remove('collapsed');
                }
            }, 800);
        }

        // ============================================
        // SISWA DATA OPERATIONS
        // ============================================
        async function loadSiswaData(force = false) {
            const tbody = document.querySelector('#table-siswa tbody');
            const dashTotal = document.getElementById('dash-total-siswa');

            if (!force && app.siswaData && app.siswaData.length > 0) {
                if (dashTotal) dashTotal.innerText = app.siswaData.length;
                updateDashboardRankings(app.siswaData);
                renderTable(app.siswaData);
                hideLoading();
                return;
            }

            tbody.innerHTML = '<tr><td colspan="20">Loading...</td></tr>';

            try {
                if (!supabase) throw new Error('Supabase tidak terinisialisasi');

                const { data, error } = await supabase
                    .from('siswa')
                    .select('*')
                    .order('created_at', { ascending: false });

                if (error) throw error;

                app.siswaData = data || [];
                if (dashTotal) dashTotal.innerText = data.length;
                updateDashboardRankings(data);
                renderTable(data);
            } catch (e) {
                console.error("Load siswa error:", e);
                showToast('Gagal memuat data: ' + e.message, 'error');
                tbody.innerHTML = '<tr><td colspan="20" style="text-align:center; color: red;">Gagal memuat data. Cek koneksi database.</td></tr>';
            } finally {
                hideLoading();
            }
        }

        function calculateStudentAverage(student) {
            const subjects = ['agama', 'pkn', 'bindo', 'mtk', 'ipa', 'ips', 'bing', 'seni', 'penjas', 'informatika', 'ketrampilan', 'mulok'];
            let total = 0;
            let count = 0;
            subjects.forEach(sub => {
                let valStr = String(student[sub] || '0').replace(',', '.');
                let val = parseFloat(valStr);
                if (!isNaN(val) && val > 0) {
                    total += val;
                    count++;
                }
            });
            return count > 0 ? (total / count) : 0;
        }

        function updateDashboardRankings(data) {
            const tbody = document.getElementById('ranking-table-body');
            if (!tbody) return;

            const rankedData = data.map(s => {
                const avg = calculateStudentAverage(s);
                return { ...s, averageScore: avg };
            }).sort((a, b) => b.averageScore - a.averageScore).slice(0, 10);

            if (rankedData.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" style="text-align:center;">Belum ada visualisasi data nilai.</td></tr>';
                return;
            }

            tbody.innerHTML = rankedData.map((s, index) => {
                let rankClass = '';
                if (index === 0) rankClass = 'color: #d97706; font-weight: bold; font-size: 1.1rem;';
                else if (index === 1) rankClass = 'color: #94a3b8; font-weight: bold; font-size: 1.1rem;';
                else if (index === 2) rankClass = 'color: #b45309; font-weight: bold; font-size: 1.1rem;';

                const subjects = ['agama', 'pkn', 'bindo', 'mtk', 'ipa', 'ips', 'bing', 'seni', 'penjas', 'informatika', 'ketrampilan', 'mulok'];
                let totalScore = 0;
                subjects.forEach(sub => {
                    let val = parseFloat(String(s[sub] || '0').replace(',', '.'));
                    if (!isNaN(val)) totalScore += val;
                });

                return `
    <tr>
      <td style="text-align: center; ${rankClass}">#${index + 1}</td>
      <td style="font-weight: 500;">${s.nama_lengkap}</td>
      <td>${s.nisn || '-'}</td>
      <td style="text-align: center; font-weight: 600;">${totalScore.toFixed(0)}</td>
      <td style="text-align: center; font-weight: bold; background: #f0f9ff; color: #0284c7;">
        ${s.averageScore.toFixed(1).replace('.', ',')}
      </td>
    </tr>
    `;
            }).join('');
        }

        function filterSiswa() {
            const query = document.getElementById('search-siswa').value.toLowerCase();
            const filterType = document.getElementById('filter-siswa').value;

            if (!app.siswaData) return;

            let filtered = app.siswaData.filter(s => {
                const searchStr = (
                    (s.nama_lengkap || '') + " " +
                    (s.nisn || '') + " " +
                    (s.no_ijasah || '')
                ).toLowerCase();
                return searchStr.includes(query);
            });

            if (filterType === 'duplicates') {
                const nisnCounts = {};
                const ijasahCounts = {};
                app.siswaData.forEach(d => {
                    const n = String(d.nisn || '').trim();
                    const i = String(d.no_ijasah || '').trim();
                    if (n && n !== '-' && n !== '0') nisnCounts[n] = (nisnCounts[n] || 0) + 1;
                    if (i && i !== '-' && i !== '0') ijasahCounts[i] = (ijasahCounts[i] || 0) + 1;
                });
                filtered = filtered.filter(d => {
                    const n = String(d.nisn).trim();
                    const i = String(d.no_ijasah).trim();
                    const isDupNisn = (n && n !== '-' && n !== '0' && nisnCounts[n] > 1);
                    const isDupIjasah = (i && i !== '-' && i !== '0' && ijasahCounts[i] > 1);
                    return isDupNisn || isDupIjasah;
                });
            } else if (filterType === 'incomplete') {
                filtered = filtered.filter(s => {
                    return !s.nisn || s.nisn === '-' || !s.no_ijasah || s.no_ijasah === '-' || !s.nama_lengkap;
                });
            }

            if (filterType === 'rank_high') {
                filtered.sort((a, b) => calculateStudentAverage(b) - calculateStudentAverage(a));
            } else if (filterType === 'rank_low') {
                filtered.sort((a, b) => calculateStudentAverage(a) - calculateStudentAverage(b));
            }

            renderTable(filtered);
        }

        function renderTable(data) {
            const tbody = document.querySelector('#table-siswa tbody');
            if (!data || data.length === 0) {
                tbody.innerHTML = '<tr><td colspan="20" style="text-align:center; padding: 20px; color: #64748b;">Data tidak ditemukan.</td></tr>';
                return;
            }

            const sourceData = (app.siswaData && app.siswaData.length > 0) ? app.siswaData : data;
            const nisnCounts = {};
            const ijasahCounts = {};
            sourceData.forEach(d => {
                const nisn = String(d.nisn || '').trim();
                const ijasah = String(d.no_ijasah || '').trim();
                if (nisn && nisn !== '-' && nisn !== '0') nisnCounts[nisn] = (nisnCounts[nisn] || 0) + 1;
                if (ijasah && ijasah !== '-' && ijasah !== '0') ijasahCounts[ijasah] = (ijasahCounts[ijasah] || 0) + 1;
            });

            tbody.innerHTML = data.map((d, i) => {
                let avg = calculateStudentAverage(d);
                let avgStr = avg > 0 ? avg.toFixed(1).replace('.', ',') : "0,0";

                const nisn = String(d.nisn || '').trim();
                const ijasah = String(d.no_ijasah || '').trim();
                const isNisnDup = (nisn && nisn !== '-' && nisn !== '0' && nisnCounts[nisn] > 1);
                const isIjasahDup = (ijasah && ijasah !== '-' && ijasah !== '0' && ijasahCounts[ijasah] > 1);

                let nisnContent = d.nisn || '-';
                let nisnStyle = '';
                if (isNisnDup) {
                    nisnContent = `<div style="color: #dc2626; font-weight: bold;">${d.nisn}</div><div style="font-size: 0.7rem; color: #dc2626; margin-top: 2px;">‚ö†Ô∏è Duplikat!</div>`;
                    nisnStyle = 'background-color: #fef2f2; border: 1px solid #fca5a5;';
                }

                let ijasahContent = d.no_ijasah || '-';
                let ijasahStyle = '';
                if (isIjasahDup) {
                    ijasahContent = `<div style="color: #dc2626; font-weight: bold;">${d.no_ijasah}</div><div style="font-size: 0.7rem; color: #dc2626; margin-top: 2px;">‚ö†Ô∏è Duplikat!</div>`;
                    ijasahStyle = 'background-color: #fef2f2; border: 1px solid #fca5a5;';
                }

                return `<tr>
    <td>${i + 1}</td>
    <td style="${nisnStyle}">${nisnContent}</td>
    <td style="text-align:left">${d.nama_lengkap}</td>
    <td>${d.tempat_lahir || ''}, ${d.tanggal_lahir || ''}</td>
    <td style="${ijasahStyle}">${ijasahContent}</td>
    <td>${d.tgl_lulus || '-'}</td>
    <td>${d.agama || '-'}</td>
    <td>${d.pkn || '-'}</td>
    <td>${d.bindo || '-'}</td>
    <td>${d.mtk || '-'}</td>
    <td>${d.ipa || '-'}</td>
    <td>${d.ips || '-'}</td>
    <td>${d.bing || '-'}</td>
    <td>${d.seni || '-'}</td>
    <td>${d.penjas || '-'}</td>
    <td>${d.informatika || '-'}</td>
    <td>${d.ketrampilan || '-'}</td>
    <td>${d.mulok || '-'}</td>
    <td style="font-weight:bold; background:#eef2ff">${avgStr}</td>
    <td>
      <div style="display: flex; gap: 4px; justify-content: center;">
        <button class="btn-action" style="background:#3b82f6" onclick="editSiswa('${d.id}')">Edit</button>
        <button class="btn-action" style="background:#8b5cf6" onclick="printSiswa('${d.nisn}')">Cetak</button>
        <button class="btn-action" style="background:#ef4444" onclick="deleteSiswa('${d.id}')">Hapus</button>
      </div>
    </td>
    </tr>`;
            }).join('');
        }

        async function deleteSiswa(id) {
            const s = app.siswaData.find(x => x.id === id);
            if (!s) return;

            if (confirm(`Apakah Anda yakin ingin menghapus data siswa: ${s.nama_lengkap}?`)) {
                showLoading('Menghapus Data...');
                try {
                    const { error } = await supabase.from('siswa').delete().eq('id', id);
                    if (error) throw error;

                    loadSiswaData(true);
                    showToast('Data Siswa Berhasil Dihapus!');
                } catch (e) {
                    showToast('Gagal: ' + e.message, 'error');
                } finally {
                    hideLoading();
                }
            }
        }

        async function saveSiswa(e) {
            e.preventDefault();
            const fd = new FormData(e.target);
            const obj = {};
            fd.forEach((v, k) => obj[k] = v);

            showLoading('Menyimpan Data Siswa...');

            try {
                const { data, error } = await supabase.from('siswa').upsert({
                    id: obj.id || undefined,
                    nama_lengkap: obj.nama_lengkap,
                    nisn: obj.nisn,
                    tempat_lahir: obj.tempat_lahir,
                    tanggal_lahir: obj.tanggal_lahir,
                    no_ijasah: obj.no_ijasah,
                    tgl_lulus: obj.tgl_lulus,
                    agama: obj.agama,
                    pkn: obj.pkn,
                    bindo: obj.bindo,
                    mtk: obj.mtk,
                    ipa: obj.ipa,
                    ips: obj.ips,
                    bing: obj.bing,
                    informatika: obj.informatika,
                    seni: obj.seni,
                    penjas: obj.penjas,
                    ketrampilan: obj.ketrampilan,
                    mulok: obj.mulok
                }).select();

                if (error) throw error;

                closeModal('modal-siswa');
                loadSiswaData(true);
                showToast('Data Siswa Berhasil Disimpan!');
            } catch (err) {
                showToast('Gagal: ' + err.message, 'error');
            } finally {
                hideLoading();
            }
        }

        // ============================================
        // CONFIG & SEKOLAH
        // ============================================
        async function editSekolah() {
            const c = app.config;
            if (!c) return;
            openModal('modal-sekolah');
            const f = document.querySelector('#modal-sekolah form');
            f.nama_sekolah.value = c.nama_sekolah || '';
            f.npsn.value = c.npsn || '';
            f.nama_kepsek.value = c.nama_kepsek || '';
            f.nip_kepsek.value = c.nip_kepsek || '';
            f.jabatan_kepsek.value = c.jabatan_kepsek || '';
            f.no_surat.value = c.no_surat || '';
            f.kota_ttd.value = c.kota_ttd || '';
            f.tgl_ttd.value = c.tgl_ttd || '';
            if (f.link_video_panduan) f.link_video_panduan.value = c.link_video_panduan || '';
        }

        async function saveSekolah(e) {
            e.preventDefault();
            const fd = new FormData(e.target);
            const obj = {};
            fd.forEach((v, k) => obj[k] = v);

            showLoading('Memperbarui Konfigurasi Sekolah...');

            try {
                // Delete existing config and insert new
                await supabase.from('config').delete().neq('key', '');

                const configRows = Object.keys(obj).map(key => ({
                    key: key,
                    value: obj[key]
                }));

                const { error } = await supabase.from('config').insert(configRows);
                if (error) throw error;

                closeModal('modal-sekolah');
                app.loadConfig();
                showToast('Konfigurasi Sekolah Berhasil Diperbarui!');
            } catch (err) {
                showToast('Gagal: ' + err.message, 'error');
            } finally {
                hideLoading();
            }
        }

        // ============================================
        // FILE UPLOAD TO SUPABASE STORAGE
        // ============================================
        async function uploadLogo(input, type) {
            if (input.files && input.files[0]) {
                showLoading('Mengupload Logo...');
                const file = input.files[0];

                try {
                    const { data, error } = await supabase.storage.from('logos').upload(`logo_${type}`, file, { upsert: true });
                    if (error) throw error;

                    // Update config with new logo path
                    await supabase.from('config').upsert({ key: `logo_${type}`, value: data.path });

                    app.loadConfig();
                    showToast('Logo Berhasil Diperbarui!');
                } catch (err) {
                    showToast('Error Upload: ' + err.message, 'error');
                } finally {
                    hideLoading();
                }
            }
        }

        async function uploadArsipFile() {
            const input = document.getElementById('arsip-upload-input');
            if (!input.files || !input.files[0]) return alert("Silakan pilih file ijazah terlebih dahulu!");

            const file = input.files[0];
            showLoading("Mengupload ke Supabase Storage...");

            try {
                const { data, error } = await supabase.storage.from('arsip').upload(`ijasah_${Date.now()}_${file.name}`, file);
                if (error) throw error;

                const { data: { publicUrl } } = supabase.storage.from('arsip').getPublicUrl(data.path);

                await supabase.from('arsip').insert({
                    nama_file: file.name,
                    link: publicUrl,
                    tanggal_upload: new Date().toISOString()
                });

                showToast("File Berhasil Diupload!");
                document.getElementById('arsip-result').classList.remove('hidden');
                document.getElementById('btn-lihat-blangko').href = publicUrl;
                input.value = '';
            } catch (err) {
                alert("Upload Gagal: " + err.message);
            } finally {
                hideLoading();
            }
        }

        // ============================================
        // PAGE NAVIGATION & UTILS
        // ============================================
        function showPage(pageId, el) {
            console.log("Showing page:", pageId);
            document.querySelectorAll('.page-view').forEach(view => view.classList.remove('active'));
            const target = document.getElementById(pageId);
            if (target) {
                target.classList.add('active');
            } else {
                const dashView = document.getElementById('view-dashboard');
                if (dashView) dashView.classList.add('active');
                return;
            }

            const titleMap = {
                'view-dashboard': 'Dashboard Overview',
                'view-master': 'Master Data & Konfigurasi',
                'view-siswa': 'Data Siswa & Nilai',
                'view-ijasah': 'Preview Transkrip Nilai'
            };
            const titleEl = document.getElementById('current-page-title');
            if (titleEl) titleEl.innerText = titleMap[pageId] || 'Sistem Ijasah';

            document.querySelectorAll('.nav-link').forEach(link => link.classList.remove('active'));
            if (el && el.classList) {
                el.classList.add('active');
            } else {
                document.querySelectorAll('.nav-link').forEach(link => {
                    const onclick = link.getAttribute('onclick');
                    if (onclick && onclick.includes(pageId)) {
                        link.classList.add('active');
                    }
                });
            }

            if (pageId === 'view-siswa') loadSiswaData();
            if (pageId === 'view-master') loadMasterData();
            if (pageId === 'view-dashboard') {
                app.loadConfig();
                loadSiswaData();
            }

            if (window.innerWidth <= 768) {
                const sidebar = document.getElementById('app-sidebar');
                if (sidebar) sidebar.classList.remove('mobile-open');
            }
        }

        function openModal(id) { document.getElementById(id).classList.remove('hidden'); }
        function closeModal(id) { document.getElementById(id).classList.add('hidden'); }

        function editSiswa(id) {
            const s = app.getSiswa(id);
            if (!s) return;
            openModal('modal-siswa');
            const f = document.querySelector('#modal-siswa form');
            f.id.value = s.id;
            f.nama_lengkap.value = s.nama_lengkap;
            f.nisn.value = s.nisn;
            if (f.tempat_lahir) f.tempat_lahir.value = s.tempat_lahir || '';
            if (f.tanggal_lahir) f.tanggal_lahir.value = s.tanggal_lahir || '';
            if (f.no_ijasah) f.no_ijasah.value = s.no_ijasah || '';
            if (f.tgl_lulus) f.tgl_lulus.value = s.tgl_lulus || '';
            ['agama', 'pkn', 'bindo', 'mtk', 'ipa', 'ips', 'bing', 'informatika', 'seni', 'penjas', 'ketrampilan', 'mulok'].forEach(k => {
                if (f[k]) f[k].value = s[k] || '';
            });
        }

        function loadMasterData(force = false) {
            app.loadConfig();
            if (!force && app.mapelList.length > 0) {
                renderMapelTable(app.mapelList);
                return;
            }
            renderMapelTable(app.mapelList);
        }

        function renderMapelTable(data) {
            const tbody = document.querySelector('#table-mapel tbody');
            tbody.innerHTML = data.map((d, i) => `<tr>
  <td>${d.no_urut}</td>
  <td>${d.nama_mapel}</td>
  <td>${d.kelompok}</td>
  <td>
    <div style="display: flex; gap: 4px; justify-content: center;">
      <button onclick="editMapel('${d.id}')" class="btn-action" style="background:#fbbf24; color:black;">Edit</button>
      <button onclick="deleteMapel('${d.id}')" class="btn-action" style="background:#ef4444; color:white;">Hapus</button>
    </div>
  </td>
  </tr>`).join('');
        }

        function toggleWatermark() {
            const paper = document.querySelector('.paper');
            const isShowing = paper.classList.contains('show-watermark');
            const newValue = !isShowing;

            if (newValue) {
                paper.classList.add('show-watermark');
                const btn = document.getElementById('btn-toggle-watermark');
                if (btn) { btn.innerText = 'Watermark: ON'; btn.style.background = '#10b981'; }
            } else {
                paper.classList.remove('show-watermark');
                const btn = document.getElementById('btn-toggle-watermark');
                if (btn) { btn.innerText = 'Watermark: OFF'; btn.style.background = '#ef4444'; }
            }

            localStorage.setItem('watermarkState', newValue);

            supabase.from('config').upsert({ key: 'show_watermark', value: String(newValue) }).then(() => {
                app.loadConfig();
                showToast(newValue ? 'Background Diaktifkan!' : 'Background Dimatikan!');
            });
        }

        function toggleSidebar() {
            const sidebar = document.getElementById('app-sidebar');
            if (window.innerWidth <= 768) {
                sidebar.classList.toggle('mobile-open');
            } else {
                sidebar.classList.toggle('collapsed');
            }
        }

        function showLoading(text = 'Memproses...') {
            const loader = document.getElementById('loading-overlay');
            if (loader) {
                loader.classList.remove('hidden');
                loader.querySelector('.loading-text').innerText = text;
            }
        }

        function hideLoading() {
            const loader = document.getElementById('loading-overlay');
            if (loader) loader.classList.add('hidden');
        }

        function showToast(message, type = 'success') {
            const container = document.getElementById('toast-container');
            if (!container) return;
            const toast = document.createElement('div');
            toast.className = `toast toast-${type}`;
            let icon = '';
            if (type === 'success') icon = '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"></polyline></svg>';
            if (type === 'error') icon = '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="8" x2="12" y2="12"></line><line x1="12" y1="16" x2="12.01" y2="16"></line></svg>';
            toast.innerHTML = `${icon} <span>${message}</span>`;
            container.appendChild(toast);
            setTimeout(() => toast.classList.add('show'), 10);
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        async function checkDatabaseConnection() {
            showLoading('Mengecek Koneksi Supabase...');
            try {
                const { count, error } = await supabase.from('siswa').select('*', { count: 'exact', head: true });

                const modal = document.getElementById('modal-debug');
                const content = document.getElementById('debug-content');

                if (modal && content) {
                    modal.classList.remove('hidden');
                    if (!error) {
                        content.innerHTML = `<strong>Koneksi Sukses!</strong>
Connected to: ${SUPABASE_URL}
Status: Online
Waktu Cek: ${new Date().toLocaleString()}`;
                    } else {
                        content.innerHTML = `<strong style="color:red">Koneksi Gagal!</strong>
Error: ${error.message}`;
                    }
                }
            } catch (err) {
                const content = document.getElementById('debug-content');
                if (content) content.innerHTML = `<strong style="color:red">Error!</strong>
${err.message}`;
            } finally {
                hideLoading();
            }
        }

        // ============================================
        // OCR & PRINT
        // ============================================
        let currentOCRData = null;

        async function processIjasahOCR(input) {
            if (!input.files || !input.files[0]) return;
            const file = input.files[0];
            showLoading('Menganalisis Dokumen...');
            try {
                let imageSource = file;
                if (file.type === 'application/pdf') {
                    document.querySelector('.loading-text').innerText = 'Memproses Halaman PDF...';
                    const arrayBuffer = await file.arrayBuffer();
                    const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
                    const page = await pdf.getPage(1);
                    const viewport = page.getViewport({ scale: 2.0 });
                    const canvas = document.createElement('canvas');
                    const context = canvas.getContext('2d');
                    canvas.height = viewport.height;
                    canvas.width = viewport.width;
                    await page.render({ canvasContext: context, viewport: viewport }).promise;
                    imageSource = canvas.toDataURL('image/jpeg');
                }
                currentOCRData = await runOcrOnImage(imageSource);
                renderOCRResults();
                hideLoading();
            } catch (error) {
                hideLoading();
                alert("Gagal memproses file: " + error.message);
                console.error(error);
            }
        }

        async function runOcrOnImage(imageSource) {
            try {
                const { data: { text } } = await Tesseract.recognize(imageSource, 'ind', {
                    logger: m => {
                        if (m.status === 'recognizing text') {
                            document.querySelector('.loading-text').innerText = `Mendeteksi Teks: ${Math.round(m.progress * 100)}%`;
                        }
                    }
                });

                const ijasahRegex = /No\.?\s*Ijazah\s*[:\s]*([\d\w\/]+)/i;
                const ijasahMatch = text.match(ijasahRegex);

                let detectedName = "";
                const startMarker = /menyatakan\s+bahwa\s*[:;]?/i;
                const endMarker = /tempat,?\s*tanggal\s*lahir/i;
                const startMatch = text.match(startMarker);
                const endMatch = text.match(endMarker);
                if (startMatch && endMatch) {
                    const startIndex = startMatch.index + startMatch[0].length;
                    const endIndex = endMatch.index;
                    if (endIndex > startIndex) {
                        const rawSegment = text.substring(startIndex, endIndex).trim();
                        const candidates = rawSegment.split('\n').map(s => s.trim()).filter(s => s.length > 3);
                        for (let cand of candidates) {
                            if (!/\d/.test(cand) && /[A-Z]/.test(cand)) {
                                detectedName = cand;
                                break;
                            }
                        }
                    }
                }

                const ttlRegex = /tempat,?\s*tanggal\s*lahir\s*[:\s]*([^\n]+)/i;
                const ttlMatch = text.match(ttlRegex);

                const nisnRegex = /Nomor\s*Induk\s*Siswa\s*Nasional\s*[:\s]*(\d+)/i;
                const nisnMatch = text.match(nisnRegex);

                if (!detectedName || detectedName.length < 3) {
                    const lines = text.split('\n');
                    for (let line of lines) {
                        const clean = line.trim();
                        if (clean.length < 3) continue;
                        if (/TERAKREDITASI|KEMENTERIAN|REPUBLIK|SEKOLAH|TAHUN|PELAJARAN|LULUS|KEPALA|TEMPAT|TANGGAL|NOMOR|DINAS|KABUPATEN/i.test(clean)) continue;
                        if (!/\d/.test(clean)) {
                            if (clean.length > 5 && clean.length < 50) {
                                detectedName = clean;
                                break;
                            }
                        }
                    }
                }

                detectedName = detectedName.replace(/[.,:;]+$/, '').trim();

                return {
                    no_ijasah: ijasahMatch ? ijasahMatch[1].trim() : "Tidak terdeteksi",
                    nama_siswa: detectedName || "Tidak terdeteksi",
                    ttl: ttlMatch ? ttlMatch[1].trim() : "Tidak terdeteksi",
                    nisn: nisnMatch ? nisnMatch[1].trim() : "Tidak terdeteksi"
                };
            } catch (e) {
                console.error("OCR Error:", e);
                return { no_ijasah: "Error", nama_siswa: "Error", ttl: "Error", nisn: "Error" };
            }
        }

        function renderOCRResults() {
            const container = document.getElementById('ocr-results-container');
            const body = document.getElementById('ocr-results-body');
            container.classList.remove('hidden');
            if (!currentOCRData) {
                body.innerHTML = '<tr><td colspan="3" style="text-align:center">Tidak ada data.</td></tr>';
                return;
            }
            const fields = [
                { key: 'nama_siswa', label: 'Nama Siswa' },
                { key: 'no_ijasah', label: 'No. Ijazah' },
                { key: 'ttl', label: 'Tempat, Tgl Lahir' },
                { key: 'nisn', label: 'NISN' }
            ];
            body.innerHTML = fields.map(f => `
  <tr>
    <td style="font-weight: 600; width: 30%;">${f.label}</td>
    <td>
      <input type="text" class="form-input"
        value="${currentOCRData[f.key] || ''}"
        onchange="updateOCRLocal('${f.key}', this.value)">
    </td>
    <td style="width: 15%; text-align: center;">
      <span class="badge ${(!currentOCRData[f.key] || currentOCRData[f.key] === 'Tidak terdeteksi') ? 'badge-danger' : 'badge-success'}">
        ${(!currentOCRData[f.key] || currentOCRData[f.key] === 'Tidak terdeteksi') ? 'Cek' : 'OK'}
      </span>
    </td>
  </tr>
  `).join('');
        }

        function updateOCRLocal(key, val) {
            if (currentOCRData) {
                currentOCRData[key] = val;
            }
        }

        function resetOCR() {
            currentOCRData = null;
            document.getElementById('ocr-results-container').classList.add('hidden');
            document.getElementById('ocr-upload-input').value = "";
        }

        async function saveOCRResult() {
            if (!currentOCRData) return;
            if (currentOCRData.nama_siswa === 'Tidak terdeteksi' || currentOCRData.nama_siswa === 'Error') {
                if (!confirm("Nama siswa belum terdeteksi sempurna. Tetap simpan?")) return;
            }
            showLoading('Menyimpan Data...');
            try {
                const { data, error } = await supabase.from('siswa').upsert({
                    nama_lengkap: currentOCRData.nama_siswa,
                    no_ijasah: currentOCRData.no_ijasah,
                    nisn: currentOCRData.nisn,
                    tempat_lahir: currentOCRData.ttl.split(',')[0] || '',
                    tanggal_lahir: currentOCRData.ttl.split(',')[1] || ''
                }).select();

                if (error) throw error;

                showToast(`Data Siswa Berhasil Disimpan!`);
                resetOCR();
                loadSiswaData(true);
            } catch (err) {
                alert('Gagal: ' + err.message);
            } finally {
                hideLoading();
            }
        }

        // ============================================
        // PRINT FUNCTIONS
        // ============================================
        function printSiswa(nisn) {
            const s = app.siswaData.find(x => String(x.nisn) === String(nisn));
            if (!s) return alert("Data siswa tidak ditemukan.");
            showPage('view-ijasah');

            document.getElementById('print-nama-siswa').innerText = s.nama_lengkap;
            document.getElementById('print-nisn-view').innerText = s.nisn;
            document.getElementById('print-ttl').innerText = (s.tempat_lahir || '') + ', ' + (s.tanggal_lahir || '');
            const noIjasahEl = document.getElementById('print-no-ijasah');
            if (noIjasahEl) noIjasahEl.innerText = s.no_ijasah || '-';
            const tglIjasahEl = document.getElementById('print-tgl-ijasah');
            if (tglIjasahEl) tglIjasahEl.innerText = s.tgl_lulus || '-';
            if (app.config.nama_sekolah) document.getElementById('print-sekolah-asal').innerText = app.config.nama_sekolah;
            if (app.config.npsn) document.getElementById('print-npsn-text').innerText = app.config.npsn;
            if (app.config.no_surat) document.getElementById('print-no-surat').innerText = "Nomor: " + app.config.no_surat;

            const kota = app.config.kota_ttd || 'Kabupaten Kepulauan Tanimbar';
            const tgl = app.config.tgl_ttd || s.tgl_lulus || '';
            const fullTTD = kota + (kota && tgl ? ', ' : '') + tgl;
            const ttdEl = document.getElementById('print-ttd-full');
            if (ttdEl) ttdEl.innerText = fullTTD;

            const tbody = document.querySelector('#print-table-nilai tbody');
            const mapping = {
                'agama': /Agama/i,
                'pkn': /Pancasila|PKN/i,
                'bindo': /Indonesia/i,
                'mtk': /Matematika/i,
                'ipa': /Alam|IPA/i,
                'ips': /Sosial|IPS/i,
                'bing': /Inggris/i,
                'informatika': /Informatika/i,
                'seni': /Seni/i,
                'penjas': /Jasmani|PJOK|Penjas/i,
                'ketrampilan': /Ketrampilan|Prakarya/i,
                'mulok': /Lokal|Mulok/i
            };

            const mapelSorted = [...app.mapelList].sort((a, b) => (a.no_urut || 0) - (b.no_urut || 0));
            let total = 0;
            let count = 0;
            let html = mapelSorted.map((m, i) => {
                const label = m.nama_mapel;
                let key = Object.keys(mapping).find(k => mapping[k].test(label));
                let valStr = String(s[key] || '0').replace(',', '.');
                let val = parseFloat(valStr);
                if (!isNaN(val) && val > 0) { total += val; count++; }
                return `<tr>
    <td style="border:1px solid black; text-align:center">${i + 1}</td>
    <td style="border:1px solid black; text-align:left; padding-left:10px;">${label}</td>
    <td style="border:1px solid black; text-align:center">${s[key] || '-'}</td>
    </tr>`;
            }).join('');

            let avg = count > 0 ? (total / count).toFixed(1).replace('.', ',') : "0,0";
            html += `<tr><td colspan="2" style="border:1px solid black; text-align:center; font-weight:bold; background:#f2f2f2;">Rata-Rata</td><td style="border:1px solid black; text-align:center; font-weight:bold;">${avg}</td></tr>`;
            tbody.innerHTML = html;
        }

        function printAllSiswa() {
            if (!app.siswaData || app.siswaData.length === 0) return alert("Tidak ada data siswa untuk dicetak.");

            const incompleteStudents = [];
            app.siswaData.forEach(s => {
                const missing = [];
                if (!s.nama_lengkap) missing.push('Nama');
                if (!s.nisn || s.nisn === '-') missing.push('NISN');
                if (!s.no_ijasah || s.no_ijasah === '-') missing.push('No Ijasah');
                if (!s.tgl_lulus) missing.push('Tanggal Lulus');
                if (missing.length > 0) {
                    incompleteStudents.push(`- ${s.nama_lengkap || 'Tanpa Nama'} (${missing.join(', ')})`);
                }
            });

            if (incompleteStudents.length > 0) {
                const confirmMsg = `PERINGATAN: Terdapat ${incompleteStudents.length} siswa dengan data belum lengkap:\n` +
                    incompleteStudents.slice(0, 10).join('\n') +
                    (incompleteStudents.length > 10 ? '\n...dan lainnya.' : '') +
                    `\nApakah Anda ingin tetap mencetak SEMUA data?`;
                if (!confirm(confirmMsg)) return;
            } else {
                if (!confirm(`Akan mencetak ${app.siswaData.length} transkrip siswa. Lanjutkan?`)) return;
            }

            const singleContainer = document.getElementById('single-print-container');
            const bulkContainer = document.getElementById('bulk-print-container');
            showLoading('Menyiapkan Dokumen Cetak...');

            setTimeout(() => {
                try {
                    singleContainer.classList.add('hidden');
                    bulkContainer.classList.remove('hidden');
                    bulkContainer.innerHTML = '';
                    const fragment = document.createDocumentFragment();
                    app.siswaData.forEach(student => {
                        const wrapper = document.createElement('div');
                        wrapper.className = 'bulk-page-wrapper';
                        wrapper.style.pageBreakAfter = 'always';
                        wrapper.innerHTML = generateTranscriptHTML(student);
                        fragment.appendChild(wrapper);
                    });
                    bulkContainer.appendChild(fragment);
                    hideLoading();
                    setTimeout(() => {
                        window.print();
                        setTimeout(() => {
                            if (confirm("Kembali ke mode preview satuan?")) {
                                bulkContainer.innerHTML = '';
                                bulkContainer.classList.add('hidden');
                                singleContainer.classList.remove('hidden');
                            }
                        }, 1000);
                    }, 500);
                } catch (e) {
                    hideLoading();
                    alert("Gagal menyiapkan cetak: " + e.message);
                    singleContainer.classList.remove('hidden');
                    bulkContainer.classList.add('hidden');
                }
            }, 100);
        }

        function generateTranscriptHTML(s) {
            const c = app.config || {};
            const namaSekolah = c.nama_sekolah || '...';
            const npsn = c.npsn || '...';
            const noSurat = c.no_surat ? "Nomor: " + c.no_surat : "Nomor: ...";
            const kota = c.kota_ttd || 'Kabupaten Kepulauan Tanimbar';
            const tgl = c.tgl_ttd || s.tgl_lulus || '';
            const fullTTD = kota + (kota && tgl ? ', ' : '') + tgl;
            const kepsek = c.nama_kepsek || '...';
            const nip = c.nip_kepsek || '...';
            const jabatan = c.jabatan_kepsek ? (c.jabatan_kepsek + ",") : ("Kepala " + namaSekolah + ",");
            const showWatermark = document.querySelector('.paper.show-watermark') ? 'show-watermark' : '';

            const storageUrl = supabase.storage.from('logos').getPublicUrl;
            const logoKiri = c.logo_kiri ? storageUrl('logo_kiri').data.publicUrl : '';
            const logoKanan = c.logo_kanan ? storageUrl('logo_kanan').data.publicUrl : '';
            const logoWatermark = c.logo_watermark ? storageUrl('logo_watermark').data.publicUrl : '';

            const mapping = {
                'agama': /Agama/i,
                'pkn': /Pancasila|PKN/i,
                'bindo': /Indonesia/i,
                'mtk': /Matematika/i,
                'ipa': /Alam|IPA/i,
                'ips': /Sosial|IPS/i,
                'bing': /Inggris/i,
                'informatika': /Informatika/i,
                'seni': /Seni/i,
                'penjas': /Jasmani|PJOK|Penjas/i,
                'ketrampilan': /Ketrampilan|Prakarya/i,
                'mulok': /Lokal|Mulok/i
            };

            const mapelSorted = [...app.mapelList].sort((a, b) => (a.no_urut || 0) - (b.no_urut || 0));
            let total = 0;
            let count = 0;
            const rowsHTML = mapelSorted.map((m, i) => {
                const label = m.nama_mapel;
                let key = Object.keys(mapping).find(k => mapping[k].test(label));
                let valStr = String(s[key] || '0').replace(',', '.');
                let val = parseFloat(valStr);
                let displayVal = s[key] || '-';
                if (!isNaN(val) && val > 0) { total += val; count++; }
                return `<tr>
    <td style="border:1px solid black; text-align:center">${i + 1}</td>
    <td style="border:1px solid black; text-align:left; padding-left:10px;">${label}</td>
    <td style="border:1px solid black; text-align:center">${displayVal}</td>
    </tr>`;
            }).join('');

            let avg = count > 0 ? (total / count).toFixed(1).replace('.', ',') : "0,0";
            const avgHTML = `<tr><td colspan="2" style="border:1px solid black; text-align:center; font-weight:bold; background:#f2f2f2;">Rata-Rata</td><td style="border:1px solid black; text-align:center; font-weight:bold;">${avg}</td></tr>`;

            return `
  <div class="paper ${showWatermark}" style="page-break-after:always;">
  <div class="watermark-bg">
  <img src="${logoWatermark}">
  </div>
  <div class="kop-header">
  <div class="kop-logo">
  <img src="${logoKiri}">
  </div>
  <div class="kop-text">
  <h3 style="margin:0; font-size:14pt; font-weight:bold;">PEMERINTAH KABUPATEN KEPULAUAN TANIMBAR</h3>
  <h3 style="margin:0; font-size:14pt; font-weight:bold;">DINAS PENDIDIKAN DAN KEBUDAYAAN</h3>
  <h2 style="margin:0; font-size:18pt; font-weight:bold;">${namaSekolah}</h2>
  <h3 style="margin:0; font-size:14pt; font-weight:bold;">ARUI BAB</h3>
  <p style="margin:0; font-size:11pt;">${document.getElementById('print-alamat').innerText}</p>
  </div>
  <div class="kop-logo">
  <img src="${logoKanan}">
  </div>
  </div>
  <div class="kop-line"></div>
  <h2 style="text-align: center; margin-top: 20px; font-size: 14pt; margin-bottom: 5px;">TRANSKRIP NILAI</h2>
  <p style="text-align: center; margin-bottom: 25px;">${noSurat}</p>
  <table class="student-info-table">
  <tr><td style="width: 280px; white-space: nowrap;">Satuan Pendidikan</td><td style="width:10px">:</td><td>${namaSekolah}</td></tr>
  <tr><td>Nomor Pokok Satuan Pendidikan</td><td>:</td><td>${npsn}</td></tr>
  <tr><td>Nama Lengkap</td><td>:</td><td>${s.nama_lengkap}</td></tr>
  <tr><td>Tempat dan Tanggal Lahir</td><td>:</td><td>${(s.tempat_lahir || '') + ', ' + (s.tanggal_lahir || '')}</td></tr>
  <tr><td>Nomor Induk Siswa Nasional</td><td>:</td><td>${s.nisn || '-'}</td></tr>
  <tr><td>Nomor Ijasah</td><td>:</td><td>${s.no_ijasah || '-'}</td></tr>
  <tr><td>Tanggal Kelulusan</td><td>:</td><td>${s.tgl_lulus || '-'}</td></tr>
  </table>
  <table class="data-table" id="print-table-nilai" style="border: 1.5px solid black !important; color: black !important; background: transparent !important;">
  <thead>
  <tr>
  <th style="background-color: rgba(242, 242, 242, 0.8) !important; border: 1px solid black !important;">No</th>
  <th style="background-color: rgba(242, 242, 242, 0.8) !important; border: 1px solid black !important;">Mata Pelajaran</th>
  <th style="background-color: rgba(242, 242, 242, 0.8) !important; border: 1px solid black !important;">Nilai</th>
  </tr>
  </thead>
  <tbody>${rowsHTML + avgHTML}</tbody>
  </table>
  <div style="margin-top: 30px; display: flex; justify-content: flex-end;">
  <div style="width: 350px; text-align: left;">
  <p style="margin-bottom: 2px; white-space: nowrap;">${fullTTD}</p>
  <p style="white-space: nowrap;">${jabatan}</p>
  <br><br><br>
  <p style="text-decoration: underline; font-weight: bold;">${kepsek}</p>
  <p>NIP. <span>${nip}</span></p>
  </div>
  </div>
  </div>`;
        }

        // ============================================
        // MAPEL OPERATIONS
        // ============================================
        async function saveMapel(e) {
            e.preventDefault();
            const fd = new FormData(e.target);
            const obj = {};
            fd.forEach((v, k) => obj[k] = v);

            try {
                const { error } = await supabase.from('mapel').insert({
                    no_urut: obj.no_urut,
                    nama_mapel: obj.nama_mapel,
                    kelompok: obj.kelompok
                });

                if (error) throw error;

                closeModal('modal-mapel');
                loadMasterData();
                showToast('Mata Pelajaran Berhasil Disimpan!');
            } catch (err) {
                showToast('Gagal: ' + err.message, 'error');
            }
        }

        async function deleteMapel(id) {
            const m = app.mapelList.find(x => x.id === id);
            if (!m) return;
            if (confirm(`Hapus mata pelajaran: ${m.nama_mapel}?`)) {
                showLoading('Menghapus Mata Pelajaran...');
                try {
                    const { error } = await supabase.from('mapel').delete().eq('id', id);
                    if (error) throw error;

                    loadMasterData(true);
                    showToast('Mata Pelajaran Berhasil Dihapus!');
                } catch (err) {
                    showToast('Error: ' + err.message, 'error');
                } finally {
                    hideLoading();
                }
            }
        }

        function editMapel(id) {
            const m = app.mapelList.find(x => x.id === id);
            if (!m) return;
            openModal('modal-mapel');
            const f = document.querySelector('#modal-mapel form');
            f.id.value = m.id;
            f.no_urut.value = m.no_urut;
            f.nama_mapel.value = m.nama_mapel;
            f.kelompok.value = m.kelompok;
        }

        // ============================================
        // IMPORT/EXPORT
        // ============================================
        function downloadTemplate() {
            showLoading('Menyiapkan Template...');
            const baseHeaders = ['No', 'NISN', 'Nama Lengkap', 'Tempat Lahir', 'Tanggal Lahir', 'No Ijasah', 'Tanggal Kelulusan'];
            const mapelSorted = [...app.mapelList].sort((a, b) => (a.no_urut || 0) - (b.no_urut || 0));
            const mapelHeaders = mapelSorted.map(m => m.nama_mapel);
            const headers = [...baseHeaders, ...mapelHeaders];
            const data = [
                headers,
                ['1', '1234567890', 'Nama Siswa Contoh', 'Sifnana', '01 Januari 2008', 'DN-01/D-0000001', '16 Juni 2025', ...mapelHeaders.map(() => '80')]
            ];
            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.aoa_to_sheet(data);
            const wscols = headers.map(h => ({ wch: h.length + 12 }));
            ws['!cols'] = wscols;
            XLSX.utils.book_append_sheet(wb, ws, "Data Siswa & Nilai");
            XLSX.writeFile(wb, "Template_Ijasah_Custom.xlsx");
            hideLoading();
            showToast('Template Berhasil Diunduh!');
        }

        function triggerImport() {
            document.getElementById('import-file').click();
        }

        function handleFileImport(input) {
            if (input.files && input.files[0]) {
                const file = input.files[0];
                const name = file.name.toLowerCase();
                if (!name.endsWith('.xls') && !name.endsWith('.xlsx')) {
                    alert('Harap upload file dalam format Excel (.xlsx atau .xls) sesuai template yang diunduh.');
                    input.value = '';
                    return;
                }
                const reader = new FileReader();
                reader.onload = function (e) {
                    try {
                        const data = new Uint8Array(e.target.result);
                        const workbook = XLSX.read(data, { type: 'array' });
                        let targetSheet = workbook.Sheets[workbook.SheetNames[0]];
                        for (let sName of workbook.SheetNames) {
                            let sheet = workbook.Sheets[sName];
                            let csv = XLSX.utils.sheet_to_csv(sheet);
                            if (csv.toUpperCase().includes('NISN')) {
                                targetSheet = sheet;
                                break;
                            }
                        }
                        const csvOutput = XLSX.utils.sheet_to_csv(targetSheet);
                        if (!csvOutput || csvOutput.trim().length === 0) {
                            alert("Data di file Excel kosong atau tidak terbaca.");
                            return;
                        }
                        sendDataToBackend(csvOutput);
                    } catch (err) {
                        alert("Gagal membaca file Excel. Error: " + err);
                        console.error(err);
                        input.value = '';
                    }
                };
                reader.readAsArrayBuffer(file);
            }
        }

        async function sendDataToBackend(csvContent) {
            showLoading('Mengimport Data...');
            try {
                const rows = csvContent.split('\n').slice(1);
                const siswaData = rows.map(row => {
                    const cols = row.split(',');
                    return {
                        nisn: cols[1],
                        nama_lengkap: cols[2],
                        tempat_lahir: cols[3],
                        tanggal_lahir: cols[4],
                        no_ijasah: cols[5],
                        tgl_lulus: cols[6],
                        agama: cols[7],
                        pkn: cols[8],
                        bindo: cols[9],
                        mtk: cols[10],
                        ipa: cols[11],
                        ips: cols[12],
                        bing: cols[13],
                        seni: cols[14],
                        penjas: cols[15],
                        informatika: cols[16],
                        ketrampilan: cols[17],
                        mulok: cols[18]
                    };
                });

                const { error } = await supabase.from('siswa').insert(siswaData);
                if (error) throw error;

                showToast(`Import Berhasil! ${rows.length} data diproses.`);
                loadSiswaData(true);
            } catch (err) {
                showToast('Import Gagal: ' + err.message, 'error');
            } finally {
                hideLoading();
                document.getElementById('import-file').value = '';
            }
        }
    </script>
</body>

</html>
